## HTTPS原理

#### 疑问三连：

1. 为什么用了HTTPS就是安全的？
2. HTTPS的实现原理是怎么样的？
3. 用了HTTPS就一定安全吗？

#### HTTPS的实现原理：
我们可能都听说过，HTTPS相对于HTTP是安全的，是因为HTTPS会对传输的数据进行加密。那这里的加密是非对称加密还是对称加密呢？

A：HTTPS在内容传输上使用的是对称加密，非对称加密只作用于证书验证阶段。

HTTPS的过程分为==证书验证==和==数据传输==阶段，具体交互如下：

![avatar](https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd7xWCpbK6ov8rlssLDRPJJKAJzXBq80MdQHDKoDS8EHm2WnKB4ibspCAg43Ndpk4V2ibIjYic2KtQLfQ/640?wx_fmt=png)

##### 1.证书验证阶段
1. 客户端发起HTTPS请求。
2. 服务端返回HTTPS证书。
3. 客户端验证证书是否合法，如果不合法则告警。

##### 2.数据传输阶段
1. 当证书校验合法时，本地生成随机数。
2. 通过公钥加密随机数，并把加密后的随机数发送给服务端。
3. 服务端通过私钥对随机数进行解密，得到随机数。
4. 使用解密后的随机数构造对称加密算法，对返回结果的内容进行加密后，发送给客户端。


##### Q：为什么数据传输是对称加密的？
1. 非对称加密效率是非常低的，而HTTP场景中通常端对端之间存在大量的交互，非对称加密的效率是无法接受的。
2. 在HTTPS场景中，只有服务端保存了私钥，一对公私钥只能实现单向加解密。

##### Q：为什么需要CA认证机构颁发证书？
- HTTP协议被认为是不安全的，主要是由于传输过程容易被监听者勾线监听，伪造服务器，而HTTPS协议主要解决的就是网络传输中的安全问题。
- 首先我们假设不存在权威认证机构，任何人都可以制造证书，这带来的安全问题就是经典的==中间人攻击==问题。具体过程如下：
![avatar](https://mmbiz.qpic.cn/mmbiz_png/R5ic1icyNBNd7xWCpbK6ov8rlssLDRPJJKCyW6OqoPnibRVTOLhXJ8EhdabSoKXA7GKNrnibDAwapNpnjQRGUQ0poA/640?wx_fmt=png)

过程原理：
1. 本地请求被劫持（如DNS劫持等），所有请求都发送至中间人的服务器。
2. 中间人服务器返回中间人自己的证书。
3. 客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输。
4. 中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密。
5. 中间人以客户端的请求内容再向正规网站发起请求。
6. 因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据。
7. 中间人凭借与正规网站建立的对称加密算法对内容进行解密。
8. 中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输。
9. 客户端通过与中间人建立的对称加密算法对返回结果数据进行解密。

由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取。

##### Q：客户端是如何确保CA证书的合法性？
1. ==证书包含什么信息？==
    - 颁发机构信息
    - 公钥
    - 公司信息
    - 域名
    - 有效期
    - 指纹
    - ......

2. ==证书的合法性依据是什么？==
    - 首先，权威机构是要有认证的，不是随便一个机构都有资格颁发证书，不然也不叫做权威机构。
    - 另外，证书的可信性基于信任制，权威机构需要对其颁发的证书进行信用背书，只要是权威机构生成的证书，我们就认为是合法的。
    - 权威机构会对申请者的信息进行审核，不同等级的权威机构对审核的要求也不一样，于是证书也分为免费的、便宜的和贵的。

3. ==客户端是如何验证证书的合法性的？==

    浏览器发起 HTTPS 请求时，服务器会返回网站的 SSL 证书，浏览器需要对证书做以下验证：
    1. 验证域名、有效期等信息是否正确。证书上都有包含这些信息，比较容易完成验证。
    2. 判断证书来源是否合法。每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证。
    3. 判断证书是否被篡改。需要与 CA 服务器进行校验；
    4. 判断证书是否已吊销。通过`CRL（Certificate Revocation List 证书注销列表，已被OCSP取代）`和 `OCSP（Online Certificate Status Protocol 在线证书状态协议）`实现，其中 OCSP 可用于第3步中以减少与 CA 服务器的交互，提高验证效率
    
    以上任意条件都满足，客户端即认为证书是合法的。
    
##### Q：证书是公开的，有没有被冒用的风险？
- 其实这就是非加密对称中公私钥的用处，虽然中间人可以得到证书，但私钥是无法获取的，中间人即使拿到证书也无法伪装成合法服务端，因为无法使用私钥对对客户端传入的随机数进行解密，进而也就无法解密传输数据。

##### Q：本地随机数被窃取怎么办？
证书验证是采用非对称加密实现，但是传输过程是采用对称加密，而其中对称加密算法中重要的随机数是由本地生成并且存储于本地的，HTTPS 如何保证随机数不会被窃取？

其实 HTTPS 并不包含对随机数的安全保证，HTTPS 保证的只是传输过程安全，而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。

##### Q：用了HTTPS会被抓包吗？

会被抓包，HTTPS 只防止用户在不知情的情况下通信被监听，如果用户主动授信，是可以构建“中间人”网络，代理软件可以对传输内容进行解密。

#### 来个实例

##### Q：如何给服务器安装https证书？
1. 申请&下载证书
2. 服务器安装证书（将下载好的证书放到指定文件夹）
3. 以Nginx为例，配置Nginx 443端口，指定证书和私钥文件夹
4. 重启Nginx
5. 防火墙开放443端口
6. 服务器的服务商处开放443端口